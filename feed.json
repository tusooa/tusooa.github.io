{
    "version": "https://jsonfeed.org/version/1",
    "title": "何事西风不待人",
    "description": "A poet, painter, and programmer.",
    "home_page_url": "http://tusooa.github.io",
    "items": [
        {
            "id": "http://tusooa.github.io/2020/10/01/Fix-firefox-address-bar-clickSelectsAll-bug/",
            "url": "http://tusooa.github.io/2020/10/01/Fix-firefox-address-bar-clickSelectsAll-bug/",
            "title": "Fix firefox address bar clickSelectsAll bug (Spoiler: no re-compilation required.)",
            "date_published": "2020-10-02T00:15:56.000Z",
            "content_html": "<p>A couple of months ago, I opened my Firefox as usual, I found out that\nwhen I click on the address bar, it dared to select everything in it\nas if any creepy browser would do! The first thing I did is to check\nthe <code>clickSelectsAll</code> pref – what I always do first after getting a\nnew install of Firefox on Windows is setting this pref to <code>false</code>,\nand setting <code>doubleClickSelectsAll</code> pref to <code>true</code>: that is the default\nbehaviour for Firefox on GNU/Linux… that time at least…</p>\n<p>Much to my disappointment, the pref are setting correctly, but nothing\nworks. I tried to search for this, but without success, maybe since\nthis bug was so new, or I was to silly to apply the right keywords\n(huh, maybe the latter one?). So I created an account on Mozilla’s\nbugtracker just to open <a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=1629135\">a bug</a>. At the same time I switched\nback to the ESR version of Firefox, which rid me (till recently) of\nthis stupid address bar but still granted me security updates. A\nfew days ago, however, Firefox ESR was unfortunately eventually shipped\nwith this bug, calling for a solution.</p>\n<a id=\"more\"></a>\n<h1 id=\"Some-more-background\"><a href=\"#Some-more-background\" class=\"headerlink\" title=\"Some more background\"></a>Some more background</h1><p>Here I will add more background because I need to complain a lot (&gt;w&lt;).\nIf you would like to see the solution directly, <a href=\"#The-solution\">jump there</a>.</p>\n<p>Someone on bugzilla pointed out that the bug had been\n<a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=1621570\">raised by someone else</a>. Following that bug, I saw that\nthe developer was being pretty toxic and just marked it as <code>WONTFIX</code>,\ndespite many people criticized the buggy behaviour and regarded\nthe original behaviour as signature of Firefox. I finally switched\nfrom Ubuntu to Gentoo after the new ESR, as I would like to have more\ncontrol of my software.</p>\n<p>Yesterday I <a href=\"https://matrix.to/#/!NREUQXSZzhWoQFQpTe:matrix.org/$16014845914171808dKKcm:matrix.org?via=matrix.org&amp;via=tusooa.xyz\">talked</a> to <a href=\"https://outsideofinfinity.wordpress.com/\">tiar</a> about the freedom\nof users to make software behave the way they want, without necessarily\nbeing a developer. I complained that many free/libre software does not\nexcel in this aspect, using Firefox >=75 as an example.</p>\n<p>The thing Firefox developers does, by removing the <code>clickSelectsAll</code>\nprefs, is actually somewhat limiting users’ freedom, as customization\nbecomes harder and harder. This kind of freedom has been brought up\nby a KDE person as <a href=\"https://phabricator.kde.org/T11091\">a goal</a> called “freedom out of the box.”\nIn short, it aims to make changing the behaviour of a program\nas easy as just using it, probably unifying the interface where a program\nis used and where a program is customized.</p>\n<p>And that is reasonable: no one should have to spend quite a long time\nreading an extraordinarily large code base just to make a tiny little\nchange that would significantly improve their lives. We will simply not\nhave that much time. I know tweaking system is fun… (should I say\naddictive?) but still, instant result is always a good-to-have.</p>\n<h1 id=\"The-solution\"><a href=\"#The-solution\" class=\"headerlink\" title=\"The solution\"></a>The solution</h1><p>For Firefox, we do have a <a href=\"https://superuser.com/questions/540851/go-back-to-not-selecting-the-whole-url-when-i-click-the-address-bar\">solution</a> without needing to\nrecompile. That is, to change the <code>omni.ja</code> pack in the Firefox\ndistribution. Based on that I managed to restore the old good\nurlbar behaviour.</p>\n<p>For my <code>firefox-bin</code> on Gentoo, the relevant file is at\n<code>/opt/firefox/browser/omni.ja</code>.</p>\n<p>First make a copy of that file:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -v /opt/firefox/browser/omni.ja omni.ja.orig</span><br></pre></td></tr></table></figure>\n<p>Then unzip the file:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir omni &amp;&amp; unzip -d omni /opt/firefox/browser/omni.ja</span><br></pre></td></tr></table></figure>\n<p>It may return 2, but does not matter.</p>\n<p>Then edit the <code>modules/UrlbarInput.jsm</code>:</p>\n<ol>\n<li><p>Change</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">this</span>._preventClickSelectsAll = <span class=\"built_in\">this</span>.focused;</span><br></pre></td></tr></table></figure>\n<p>to</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">this</span>._preventClickSelectsAll = <span class=\"literal\">true</span>;</span><br></pre></td></tr></table></figure>\n<p>to get the <code>clickSelectsAll</code> behaviour.</p>\n</li>\n<li><p>Change</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br></pre></td></tr></table></figure>\n<p>to</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (event.detail == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.select();</span><br><span class=\"line\">  event.preventDefault();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br></pre></td></tr></table></figure>\n<p>to get the <code>doubleClickSelectsAll</code> behaviour.</p>\n<p>Note that this will <em>not</em> put the url into primary selection\nupon double click. This can be useful sometimes, if you just\nwould like to replace the current url with the one currently\nin primary selection.\nIf you would like to put the url into primary selection\nupon double click, which completely restores the original\nbehaviour, change it to</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (event.detail == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.inputField.select();</span><br><span class=\"line\">  event.preventDefault();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br></pre></td></tr></table></figure>\n<p>instead.</p>\n</li>\n</ol>\n<p>I have also made a patch:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">] diff -Naur omni-old omni</span><br><span class=\"line\">diff -Naur omni-old/modules/UrlbarInput.jsm omni/modules/UrlbarInput.jsm</span><br><span class=\"line\">--- omni-old/modules/UrlbarInput.jsm    2010-01-01 00:00:00.000000000 -0500</span><br><span class=\"line\">+++ omni/modules/UrlbarInput.jsm        2020-10-01 19:50:41.925266392 -0400</span><br><span class=\"line\">@@ -2225,7 +2225,7 @@</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         this.focusedViaMousedown = !this.focused;</span><br><span class=\"line\">-        this._preventClickSelectsAll = this.focused;</span><br><span class=\"line\">+        this._preventClickSelectsAll = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (event.target != this.inputField) &#123;</span><br><span class=\"line\">           this.focus();</span><br><span class=\"line\">@@ -2242,7 +2242,11 @@</span><br><span class=\"line\">           this.selectionStart = this.selectionEnd = 0;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">-        <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br><span class=\"line\">+        // doubleClickSelectsAll</span><br><span class=\"line\">+        <span class=\"keyword\">if</span> (event.detail == 2) &#123;</span><br><span class=\"line\">+          this.select();</span><br><span class=\"line\">+          event.preventDefault();</span><br><span class=\"line\">+        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br><span class=\"line\">           this._preventClickSelectsAll = <span class=\"literal\">true</span>;</span><br><span class=\"line\">           this.search(UrlbarTokenizer.RESTRICT.SEARCH);</span><br><span class=\"line\">         &#125; <span class=\"keyword\">else</span> &#123;</span><br></pre></td></tr></table></figure></p>\n<p>There is also the search bar to change. The original Superuser answer\nsuggests this, but as I do not use the search bar, I have not\ntried it out, nor do I know what the original behaviour of it was.\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i <span class=\"string\">&#x27;s/this\\._preventClickSelectsAll = this\\._textbox\\.focused;/this._preventClickSelectsAll = true;/&#x27;</span>  omni/chrome/browser/content/browser/search/searchbar.js</span><br></pre></td></tr></table></figure></p>\n<p>After editing, we need to re-pack the files:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> omni &amp;&amp; zip -0DXqr ../omni.ja * &amp;&amp; <span class=\"built_in\">cd</span> -</span><br></pre></td></tr></table></figure></p>\n<p>And replace the original one:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -v omni.ja /opt/firefox/browser/omni.ja</span><br></pre></td></tr></table></figure></p>\n<p>You may need to change the ownership of the newly-created archive:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown [U]:[G] /opt/firefox/browser/omni.ja</span><br></pre></td></tr></table></figure>\nwhere <code>[U]</code> and <code>[G]</code> refers to the owner and group of the original\nfile (we made a backup at <code>omni.ja.orig</code>).</p>\n<p>To ensure everything takes effect, make a file called <code>.purgecaches</code>\nto make Firefox aware of the changes:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch /opt/firefox/browser/.purgecaches</span><br></pre></td></tr></table></figure></p>\n<p>Okay, from now on, we shall no longer suffer from the <code>clickSelectsAll</code>\nbug.</p>\n<p>Also, you may want to have additional configurations, such as\n<a href=\"https://www.userchrome.org/megabar-styling-firefox-address-bar.html\">disabling the pop-up list upon clicking address bar</a>\nor <a href=\"https://github.com/WesleyBranton/Remove-Firefox-Megabar/blob/master/remove_megabar.css\">gettind rid of the address bar expanding effect</a>\nwhen clicked upon.</p>\n",
            "tags": [
                "firefox",
                "无奈",
                "坑",
                "javascript"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/08/24/Pay-another-respect-to-kritacommand-which-we-are-going-beyond/",
            "url": "http://tusooa.github.io/2019/08/24/Pay-another-respect-to-kritacommand-which-we-are-going-beyond/",
            "title": "Pay another respect to kritacommand--which we are going beyond",
            "date_published": "2019-08-24T23:51:09.000Z",
            "content_html": "<blockquote>\n<p>Your work is gonna make Krita significantly different.\n– <a href=\"https://invent.kde.org/woltherav\">Wolthera</a>, Krita developer and digital artist</p>\n</blockquote>\n<p>Krita’s undo system, namely <code>kritacommand</code>, was <a href=\"https://invent.kde.org/kde/krita/commit/76fc48a7ce15afb93c072d4faa77da831517ee52\">added</a> 8 years ago to Calligra under the name of <code>kundo2</code>, as a fork of Qt’s undo framework. The use of undo commands, however, might have an even longer history. Undo commands provide a way to revert individual actions. Up to now, most (<a href=\"https://invent.kde.org/kde/krita/merge_requests/32/diffs\">though not all</a>) undo commands do it by providing two sets of code that do and undo the actions, respectively. Drawbacks of this system includes (1) it is not very easy to manage; (2) it may introduce duplicated code; and (3) it makes it hard to access a previous document state without actually going back to that state. What I do is to start getting rid of such situation.</p>\n<p>The plan for a new system is to use shallow copies to store documents at different states. Dmitry said “it was something we really want to do and allows us to make historical brushes (fetch content from earlier document states).” And according to him, he spent years to implement copy-on-write on paint layers. He suggested me to start from vector layers which he thought would be easier since it does not need to be very thread-safe. </p>\n<p>I completely understood that was a challenge, but did not realize where the difficult part was until I come here. Copy-on-write is not the challenging part. We have <code>QSharedDataPointer</code> and almost all the work is to routinely replace the same code. Porting tools is more difficult. The old flake tools are running under the GUI thread, which makes no requirement on thread-safety. Technically we do not need to run it in a stroke / in image thread but with no multithreading the tools runs too slowly on some computers (read as “my Thinkpad laptop”) so I am not unwilling to take this extra challenge. In previous posts I described how the strokes work and the problems I encountered. Besides that there are still some problems I need to face.</p>\n<h2 id=\"the-HACK-code-in-the-stroke-strategy\"><a href=\"#the-HACK-code-in-the-stroke-strategy\" class=\"headerlink\" title=\"the HACK code in the stroke strategy\"></a>the HACK code in the stroke strategy</h2><p>At the last of the strokes post, I proposed a fix to the crash when deleting <code>KisNode</code>, which is messy. After testing with Dmitry at the sprint, we discovered that the real problems lies in <code>KoShapeManager</code>‘s <code>updateTreeCompressor</code>. It is used to schedule updates of its R-tree. However, it is run at the beginning of every other operation so Dmitry says it is no longer needed. After the compressor was removed we are safe to delete the node normally so there would be no need for such hack code.</p>\n<h2 id=\"Path-tool-crashing-when-editing-calligraphic-shapes\"><a href=\"#Path-tool-crashing-when-editing-calligraphic-shapes\" class=\"headerlink\" title=\"Path tool crashing when editing calligraphic shapes\"></a>Path tool crashing when editing calligraphic shapes</h2><p>Calligraphic shapes, coming from Karbon, is a shape created by hand-drawing. It has many path points and editing it using path tool usually leads to a crash. Dmitry tested it with ASan and discovered the problem occurs because the path points, which is fetched in the GUI thread to paint the canvas, could be deleted when editing the shape. He suggests to apply a lock to the canvas, not allowing the image and GUI threads to access the shapes concurrently.</p>\n<h2 id=\"Keeping-selections-after-undo-redoing\"><a href=\"#Keeping-selections-after-undo-redoing\" class=\"headerlink\" title=\"Keeping selections after undo/redoing\"></a>Keeping selections after undo/redoing</h2><p>This challenge is a smaller one. The shape selections were not kept, since they are not part of the layer. It was owned by the layer’s shape manager, though, but a cloned layer would take a brand-new shape manager. In addition <code>undo()</code> and <code>redo()</code> will now replace the whole layer, so pointers to original shapes are no longer valid. This means merely keeping the selections from the shape manager would not work. The solution is to map the selected shapes to the cloned layer, which would be kept in the undo command. The strategy I use is similar to what we have done for layers: go through the whole heirarchy of the old layer and push everything into a queue; go through the heirarchy of the cloned layer in the same order and each time take the first shape in the queue; if the popped shape is in the selection, we add its counterpart in the cloned layer to our new selection.</p>\n<p>For now the tools should be working and the merge request is prepared for final review. Hopefully it would make its way to <code>master</code> soon.</p>\n",
            "tags": [
                "kde",
                "krita",
                "c++",
                "tech"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/08/21/The-Sprint/",
            "url": "http://tusooa.github.io/2019/08/21/The-Sprint/",
            "title": "The Sprint",
            "date_published": "2019-08-22T03:16:54.000Z",
            "content_html": "<p>Hi -)) haven’t posted for some time, because I was busy travelling and coding for the first half of the month. From Aug 5 to Aug 9, I went to the Krita Sprint in Deventer, Netherlands.</p>\n<p>According to Boud, I was the first person to arrive. My flight took a transit via Hong Kong where some flights were affected due to natural and social factors, but fortunately mine was not one of them. Upon arrival in Amsterdam I got a ticket for the Intercity to Deventer. Railway constructions made me take a transfer via Utrecht Centraal, but that was not a problem at all: the station has escalators going both up to the hall, and down to the platforms (in China you can only go to the hall by stairs or elevator (which is often crowded after you get off)). When I got out of Deventer Station, Boud immediately recognized me (how?!). It was early in the morning, and the street’s quietness was broken by the sound of me dragging my suitcase. Boud led me through Deventer’s crooked streets and alleys to his house. </p>\n<p>For the next two days people gradually arrived. I met my main mentor <a href=\"https://invent.kde.org/dkazakov\">Dmitry</a> (magician!) and his tiger, Sagoskatt, which I (and many others) have mistaken for a giraffe. He was even the voice actor for Sago. He had got quite a lot of insights into the code base (according to Boud, “80%”) and solved a number of bugs in Krita (but he said he introduced a lot of bugs, ha!). Also I met David Revoy (my favourite painter!), the author of <a href=\"https://peppercarrot.com\">Pepper and Carrot</a>. And Tiar, our developer who started to work full-time on Krita this year; she had always been volunteering to support other Krita users and always on the IRC and Reddit. And two of other three GSoC students for the year: <a href=\"https://invent.kde.org/albertofl\">Blackbeard</a> (just as his face) and <a href=\"https://invent.kde.org/kuntalmajumder\">Hellozee</a>. <a href=\"https://invent.kde.org/szaman\">Sh_zam</a> could not come and lost communications due to political issues, which was really unfortunate (eh at least now he can be connected). It is feels so good to be able to see so many people in the community – they are so nice! And it is such an experience to hack in a basement church.</p>\n<p>On Aug 7 we went to the Open Air Museum. It displays a large extent of the history in the Netherlands, how their people lived. After a really delicious lunch we went out and started to do paintings. I was to paint on my Surface using Krita, but unfortunately it went out of battery so I had to gave up and painted on a postcard. The tram in the museum is my favourite one (I am always fond of transit) and they even have a carhouse where stood lots of old vehicles. Except for my head which hit the ceiling of the coach three times, everything that day was wonderful.</p>\n<p>The next day was the main meeting. In the morning we discussed the development plans for Krita. Bugs. Stability. New features. David Revoy came up again with the <a href=\"https://bugs.kde.org/show_bug.cgi?id=407851\">docker size problem</a>, which Boud simply called it “a Qt problem.” He said, “Yes I do know what to do with that, but new users probably don’t and thus we gotta address it and not solely blame Qt.” (Yeah it troubled me a lot as well!) Another thing closely related to me was <a href=\"https://invent.kde.org/websites/docs-krita-org/merge_requests/57\">building on Windows</a>, which was largely neglected by KDE. In the afternoon the focus shifted to marketing. I did not know much about it, but it is a fact that we cannot produce electricity out of love. We spent quite a lot of time on the painting competition for Krita. Where it should be held. How to collect the paintings. How to filter out good pictures. Krita promotes new artists. They promote our software. </p>\n<p>For the next two days people started leaving. I left on the 10th, and then slept for a whole day when I got to Nanjing (so tired…). On Aug 14th I left again for Toronto, and then restarted to write code and debug. I finally got the time to write this post today, as I finally fixed a crash in my project. It is almost finished, and soon another post would be made on it.</p>\n",
            "tags": [
                "kde",
                "krita"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/07/26/Strokes-are-Working-Now/",
            "url": "http://tusooa.github.io/2019/07/26/Strokes-are-Working-Now/",
            "title": "Strokes are Working Now",
            "date_published": "2019-07-26T15:40:29.000Z",
            "content_html": "<p>Okay, good news today. I have been porting DefaultTool to the new node-replacing system and \nit is working now, finally, at least for the part I have already done.</p>\n<p>The work involves combining a number of different modules in Krita: the stroke system,\nKoInteractionTool and its interaction strategies, and, well, the COW mechanism in Flake.</p>\n<p><code>KoInteractionTool</code> is the class used to manage the interaction with vector shapes, and \nis subclassed by <code>DefaultTool</code>. The behaviours of <code>KoInteractionTool</code> (and thus <code>DefaultTool</code>) \nare defined by <code>KoInteractionStrategy</code>s. Upon the press of the mouse button, <code>DefaultTool</code> \ncreates an instance of some subclass of <code>KoInteractionStrategy</code>, say, <code>ShapeMoveStrategy</code>, \naccording to the point of the click as well as keyboard modifiers. Mouse move events after that \nare all handled by the interaction strategy. When the mouse is released, the interaction strategy’s \n<code>finishInteraction()</code> is called, and then <code>createCommand()</code>. If the latter returns some \n<code>KUndo2Command</code>, the command is added to the undo history. Till now it sounds simple.</p>\n<p>So how does the stroke system come in? I have experimented the interaction strategy \nwithout the stroke system (<a href=\"commit\">https://invent.kde.org/tusooaw/krita/commit/638bfcd84c622d3cfefda1e5132380439dd3fdc2</a>), \nbut it is really slow and even freezes Krita for a while sometimes. The stroke system \nallows the modification of the shapes to run in the image thread, instead of the GUI thread. \nA stroke is a set of jobs scheduled and run by a <code>KisStrokesFacade</code> (here, <code>KisImage</code>). \nOne creates the stroke in a strokes facade using a stroke strategy, which defines the behaviour \nof the stroke. After creation, jobs can be added to the stroke and then executed at some later \ntime (it is asynchronous). </p>\n<p>So combining these two, we have an interaction strategy and a stroke strategy – \nwhen the interaction strategy is created, we start the stroke in the image; \nwhen there is mouse move, we add individual jobs that change the shapes to the stroke; \nwhen the mouse released, we end the stroke. \nMy discussion with Dmitry firstly tended to make the interaction strategy inherit \nthe stroke strategy but later it proves not a viable solution since the interaction \nstrategy is owned and deleted by <code>KoInteractionTool</code> while the stroke strategy is owned \nby the stroke — which will lead to double deletion. So we divide it into two classes \ninstead: the interaction strategy starts the stroke, and the stroke strategy takes a copy \nof the current active layer upon creation; when handling mouse move events, a job is added \nto the stroke to modify the current layer; finally when the interaction finishes, \nthe interaction strategy ends the stroke and creates an undo command if the layer has been \nchanged.</p>\n<p>A problem I found lies in the final stage–if the mouse is released as soon as being pressed \nand no undo command is created, Krita will simply crash. It does not happen when I use <code>gdb</code> \nto start Krita so it seems to be a timing issue though it leads to difficulty for debugging as \nwell. Dmitry used a self-modified version of Qt to produce a backtrace, indicating the problem \nprobably lies in <code>KisCanvas2</code>‘s <code>canvasUpdateCompressor</code>, which is not thread-safe. However, \nafter I changed it to <code>KisThreadSafeSignalCompressor</code>, the crash still happens, unfortunately. </p>\n<p>The final inspiration comes from the comments in <code>KisThreadSafeSignalCompressor</code>, though. It \nindicates we cannot delete the compressor from other threads — we have to use <code>obj-&gt;deleteLater()</code> \ninstead, since it lies in the gui thread. And aha, that is the problem. The stroke strategy’s destructor \nis executed in the image thread; if the undo command is not created, there is only one reference to \nour copied <code>KisNode</code>, namely in our stroke strategy, so it has to be destructed there. However, upon \nthe creation of the <code>KisNode</code>, it is moved into the gui thread. So it simply means we cannot let it \nbe deleted in the image thread. The solution looks a little bit messy, but it works:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KisNode *node = m_d-&gt;originalState.data(); <span class=\"comment\">// take the address from KisSharedPtr</span></span><br><span class=\"line\">node-&gt;ref(); <span class=\"comment\">// prevent KisSharedPtr from deleting the node</span></span><br><span class=\"line\">m_d-&gt;originalState.clear(); <span class=\"comment\">// now node is not being referenced by any KisSharedPtr</span></span><br><span class=\"line\">node-&gt;deref(); <span class=\"comment\">// the reference count is now zero again</span></span><br><span class=\"line\">node-&gt;deleteLater(); <span class=\"comment\">// it will be deleted by the event loop, later</span></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "kde",
                "krita",
                "c++",
                "tech"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/07/09/make-j5-kritaflake/",
            "url": "http://tusooa.github.io/2019/07/09/make-j5-kritaflake/",
            "title": "`make -j5 kritaflake`",
            "date_published": "2019-07-09T17:37:14.000Z",
            "content_html": "<p>At the end of June I finished copy-on-write vector layers. From the very beginning, I have been \n<a href=\"https://tusooa.github.io/2019/05/18/Polymorphism-and-Implicit-Sharing/\">researching into</a> \npossibilities to make <code>kritaflake</code> implicitly sharable. In that post I mentioned the way \nSean Parent uses for Photoshop, and adapted it for the derived d-pointers in Flake. </p>\n<h2 id=\"Derived-d-pointers\"><a href=\"#Derived-d-pointers\" class=\"headerlink\" title=\"Derived d-pointers\"></a>Derived d-pointers</h2><p>TL;DR: We got rid of it.</p>\n<p>As I mentioned in the <a href=\"https://phabricator.kde.org/T10901\">task page</a>, derived d-pointers originally \nin Flake are a barrier to implicit sharing. One of the reasons is that we need to write more code (either \n<code>KisSharedDescendent</code> wrapper class, or repeated code for virtual clone functions). Also, derived \nd-pointers do not actually encapsulate the data in the parent classes – for example, the members in \n<code>KoShapePrivate</code> are all accessible by descendents of <code>KoShape</code>, say, <code>KoShapeContainer</code>. That is probably \nnot how encapsulating should work. So in the end we decided to get rid of derived d-pointers in Flake.</p>\n<p>This leads to one problem, however, in the class <code>KoShapeGroup</code>. <code>KoShapeGroup</code> is a descendent of <code>KoShapeContainer</code>, \nwhich owns a <code>KoShapeContainerModel</code> that can be subclassed to control the behaviour when a child is added to or \nremoved from the container. <code>KoShapeGroup</code> uses <code>ShapeGroupContainerModel</code> which performs additional operations \nspecific to <code>KoShapeGroup</code>.</p>\n<p>After I merged my branch into master, it was said that Flake tests failed under address sanitizer (ASan). I \ntook a look and discovered that there was use after free in the class <code>KoShapeGroup</code>, namely the use of its \nd-pointer. The use is called by the destructor of <code>KoShapeContainer</code>, which calls \n<code>KoShapeContainerModel::deleteOwnedShapes()</code>, which removes individual shapes \nfrom the container, which then calls <code>KoShapeGroup::invalidateSizeCache()</code>. The original situation was:</p>\n<ol>\n<li>destructor of <code>KoShapeGroup</code> was called; </li>\n<li>members defined in <code>KoShapeGroup</code> got deleted (nothing, because \neverything is in the derived d-pointer which is defined in <code>KoShape</code>); </li>\n<li>destructor of <code>KoShapeContainer</code> \nwas called, which calls <code>d-&gt;model-&gt;deleteOwnedShapes()</code>; </li>\n<li>then that of <code>KoShape</code>, which deletes all the private members. </li>\n</ol>\n<p>But after the derived d-pointers are converted to normal ones, the calling sequence upon destruction \nbecomes: </p>\n<ol>\n<li>destructor of <code>KoShapeGroup</code> was called; </li>\n<li>members defined in <code>KoShapeGroup</code> got deleted (its own d-pointer); </li>\n<li>destructor of <code>KoShapeContainer</code> was called, which calls <code>d-&gt;model-&gt;deleteOwnedShapes()</code>; </li>\n<li><code>d-&gt;model</code> is a <code>ShapeGroupContainerModel</code>, which will call <code>KoShapeGroup::invalidateSizeCache()</code>; </li>\n<li>that last function accesses the d-pointer of <code>KoShapeGroup</code>, USE AFTER FREE. </li>\n</ol>\n<p>In order to solve this problem we have to manually call <code>model()-&gt;deleteOwnedShapes()</code> in the destructor \nof <code>KoShapeGroup</code>, at which time the d-pointer is still accessible.</p>\n<h2 id=\"q-pointers\"><a href=\"#q-pointers\" class=\"headerlink\" title=\"q-pointers\"></a>q-pointers</h2><p>TL;DR: We also got rid of it. </p>\n<p>q-pointers are a method used in Qt to hide private methods from the header files, in order to improve \nbinary compatibility. q-pointers are stored in *Private classes (<code>d</code>s), indicating the object that owns \nthis private instance. But this is, of course, conflicting with the principle of “sharing” because \nthe situation now is that multiple objects can own the same data. The q-pointers in flake is rather confusing \nunder such circumstances, since the private data cannot know which object is the caller. </p>\n<p>To avoid this confusion, there are multiple ways:</p>\n<ol>\n<li>to move all the functions regarding q-pointers to the public classes; </li>\n<li>to pass the q-pointer every time when calling those functions in private classes; or </li>\n<li>to add another layer of “shared data” in the d-pointer and keep the q-pointers in the unshared part. </li>\n</ol>\n<h2 id=\"implicit-sharing\"><a href=\"#implicit-sharing\" class=\"headerlink\" title=\"implicit sharing\"></a>implicit sharing</h2><p>To enable implicit sharing for the <code>KoShape</code> hierarchy, the only thing left to be done is to \nchange the <code>QScopedPointer&lt;Private&gt; d;</code> in the header file to <code>QSharedDataPointer&lt;Private&gt; d;</code> \nand make the private classes inherit <code>QSharedData</code>. This step is rather easy and then just run the \ntests to make sure it does not break anything. Horray! </p>\n",
            "tags": [
                "kde",
                "krita",
                "c++",
                "tech"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/06/21/Snapshot-Docker/",
            "url": "http://tusooa.github.io/2019/06/21/Snapshot-Docker/",
            "title": "Snapshot Docker",
            "date_published": "2019-06-21T15:40:38.000Z",
            "content_html": "<p>Over the past few weeks I have been working on the <a href=\"https://phabricator.kde.org/T10991\">Snapshot Docker</a>, \nand now it is finished already. -))</p>\n<p>The idea of snapshots is to make copies of the current document and allow users to return to them at a later \ntime. This is a part of my whole Google Summer of Code project, which aims to bring Krita a better undo/redo \nsystem. When fully implemented, it will fully replace the current mechanism that stores actions with one that \nstores different states. That is to say, Krita will create a snapshot of the document for every undoable step.</p>\n<p>Snapshot Docker is not only a feature requested by artists but also a experimental implementation of the \nclone-replace mechanism. It has the following key parts:</p>\n<ol>\n<li><p>Cloning the document, which is provided by <code>KisDocument::lockAndCloneForSaving()</code>, which is already implemented \nin master.</p>\n</li>\n<li><p>Replace the current document by another one, which is previously cloned.</p>\n</li>\n</ol>\n<p>Part (1) is already implemented so the work falls mainly on Part (2). My original approach is to replace the \ndocument and image pointers in <code>KisView</code> and <code>KisCanvas</code>, but it is not viable since other parts of the program \nhave signal/slot connections on the <code>KisDocument</code> and <code>KisImage</code>, and directly replacing the two pointers will \nnot only fail to work but also cause weird crashes. After discussing with <a href=\"https://invent.kde.org/dkazakov\">Dmitry</a>, \nwe find out that it is probably better not to touch these two pointers, but to replace the content within\n<code>KisDocument</code> and <code>KisImage</code>. It is therefore suggested that two member functions be made, namely \n<code>KisDocument::copyFromDocument</code> and <code>KisImage::copyFromImage</code>. These functions copies data from another document/image \nto the current one, avoiding the changes to the pointers inside the original instance. Eh, except for the nodes, \nsince we have to reset and refresh the nodes in the image. </p>\n<p>It is also important to notify other parts of Krita about the change in the document. One important thing is \ntell the layer docker about the changes in the nodes (they are completely different), which is done using the \n<code>KisImage::sigLayersChangedAsync()</code> signal. The current activated node is also stored and restored, by using \nthe strategy of linearizing the layer tree using a queue, and then finding the corresponding node in the cloned \nimage. Note that when restoring, we are unable to find layer by uuid, since they should change when copied to \nthe current image (the comments in <code>KisImage</code> says the only situation where we should keep the uuids is for saving).</p>\n<p>Another interesting thing is the palettes. Krita 4.2.0 allows documents to store their own, local palettes. \nThe palette list is but a <code>QList&lt;KoColorSet *&gt;</code>, meaning that only creating a new <code>QList</code> of the same pointers \nwill not work. This is because, the palettes are controlled by canvas resource manager, which takes the responsibility \nto delete them. Therefore, when taking snapshots, we had better take deep copies of the <code>KoColorSet</code>s. And then \nanother problem comes: the snapshots own their <code>KoColorSet</code>s because they are not controlled by the resource manager \nin any way; but the <code>KisDocument</code> in the view does not. So we have to set up another flag, <code>ownsPaletteList</code>, to \ntell the document whether it should delete the palettes in the destructor.</p>\n<p>And now the work has shifted to the refactoring of <code>kritaflake</code>, the library that mainly handles vector layers and \nshapes. I converted the whole <code>KoShape</code> hierarchy to implicit sharing where possible, but some tests are broken. I \nam now on Windows, where unit tests do not run. I will continue the development of flake as soon as I get access to \nmy Linux laptop.</p>\n",
            "tags": [
                "kde",
                "krita"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/06/16/New-Style-Signal-Slot-Connection/",
            "url": "http://tusooa.github.io/2019/06/16/New-Style-Signal-Slot-Connection/",
            "title": "New Style Signal/Slot Connection",
            "date_published": "2019-06-17T00:12:56.000Z",
            "content_html": "<p>Yes, I know. The last post on the assistants is rather boring. And yet these days I have been \nworking on the <a href=\"https://invent.kde.org/kde/krita/merge_requests/41\">snapshot docker</a>, though \nit still seems a little (just a little, you see) unfinished as Dmitry is said to experience \na relatively high delay when switching between snapshots. However this is not what I can reproduce \non my older laptop, so I am really waiting for his test results in order to further investigate \nthe problem.</p>\n<p>But there <em>is</em> something interesting happening just when I am randomly testing things. From\nKrita’s debug output, I saw <code>QObject::connect()</code> complaining about the arguments I passed, \nsaying it is expecting parenthesis. “Okay,” I thought, “then there have to be something wrong \nwith the <a href=\"https://invent.kde.org/kde/krita/merge_requests/41/diffs?commit_id=8c465f12139318e86ab36d343e1db8bbbb141e06\">code I wrote</a>.” \nAnd that was quite confusing. I remember having used member function pointers in those places, \ngot a compile-time error since <code>KisSignalAutoConnectionsStore</code> did not support the new syntax,\nthen switched back to the <code>SINGAL()</code> and <code>SLOT()</code> macros. <code>KisSignalAutoConnectionsStore</code> is \na helper class to quickly (dis)connect a group of connections. One can use the <code>addConnection()</code> \nmethod to add a connection, and use <code>clear()</code> to remove all connections made before. </p>\n<p>Well, everything good, apart from the fact that I missed the parenthesis, which I did not \ndiscover until I looked into the debug output. So I asked Dmitry why not add the new syntax \nto <code>KisSignalAutoConnectionsStore</code>, and he said we should. </p>\n<p>What is good about the new syntax is compile-time checking. We probably do not want our connections\nto fail to be made only when you run the program, just because there is a typo in the signature. \nThat is definitely tiring and hard to catch (hmm, I did not notice the problem until today I \nrandomly glanced at the command line; it might be worse if I shipped the snapshot docker together \nwith those careless bugs).</p>\n<p>The modification to the code seems straightforward. All what happens is in the <code>KisSignalAutoConnection</code> \nclass. In its constructor, the connection is made using <code>QObject::connect()</code>; in its destructor, \nthe connection is removed by passing the same sets of arguments to <code>QObject::disconnect()</code> currently \nin <code>master</code>. The signature is just <code>KisSignalAutoConnection(const QObject *, const char *, const QObject *, const char *)</code>, \nas <code>SIGNAL()</code> and <code>SLOT()</code> macros are but to append their arguments to the string <code>&quot;1&quot;</code> and <code>&quot;2&quot;</code> respectively. </p>\n<p>So the problem we have is we do not want the arguments that specify the signals and/or slots \nto be just strings. We want them to be pointers to member functions, or maybe lambdas. \nAccording to QObject document, the signature for new-style <code>connect()</code> is:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">QMetaObject::Connection <span class=\"title\">QObject::connect</span><span class=\"params\">(<span class=\"keyword\">const</span> QObject *sender, PointerToMemberFunction signal, <span class=\"keyword\">const</span> QObject *context, Functor functor, Qt::ConnectionType type = Qt::AutoConnection)</span></span></span><br></pre></td></tr></table></figure>\n<p>Okay, so we know that <code>sender</code> and <code>receiver</code> should be pointers to <code>QObject</code>s, and \neither the type of <code>signal</code> or <code>functor</code> we do not know. \nNow let’s make our <code>KisSignalAutoConnection</code> constructor a template function: </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Signal</span>, <span class=\"title\">class</span> <span class=\"title\">Method</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"title\">inline</span> <span class=\"title\">KisSignalAutoConnection</span>(<span class=\"title\">const</span> <span class=\"title\">QObject</span> *<span class=\"title\">sender</span>, <span class=\"title\">Signal</span> <span class=\"title\">signal</span>,</span></span><br><span class=\"line\"><span class=\"class\">                               <span class=\"title\">const</span> <span class=\"title\">QObject</span> *<span class=\"title\">receiver</span>, <span class=\"title\">Method</span> <span class=\"title\">method</span></span></span><br><span class=\"line\"><span class=\"class\">                               <span class=\"title\">Qt</span>:</span>:ConnectionType type = Qt::AutoConnection);</span><br></pre></td></tr></table></figure>\n<p>But when these parameters are passed to <code>QObject::connect()</code>, we get a compile-time error, saying \nthere is no matching overload for <code>connect()</code>.</p>\n<p>Why?</p>\n<p>The answer is the Qt documentation is simplifying, if not hiding, the truth. The real definition \nfor <code>connect()</code> is found in Line 227 of <code>qobject.h</code>:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">typename</span> Func1, <span class=\"keyword\">typename</span> Func2&gt;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">inline</span> QMetaObject::Connection <span class=\"title\">connect</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">typename</span> QtPrivate::FunctionPointer&lt;Func1&gt;::Object *sender, Func1 signal,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                 <span class=\"keyword\">const</span> <span class=\"keyword\">typename</span> QtPrivate::FunctionPointer&lt;Func2&gt;::Object *receiver, Func2 slot,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                 Qt::ConnectionType type = Qt::AutoConnection)</span></span></span><br></pre></td></tr></table></figure>\n<p>And tracking down the definition of <code>QtPrivate::FunctionPointer</code>, we get it in <code>qobjectdefs_impl.h</code>:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Obj</span>, <span class=\"title\">typename</span> <span class=\"title\">Ret</span>, <span class=\"title\">typename</span>... <span class=\"title\">Args</span>&gt; <span class=\"title\">struct</span> <span class=\"title\">FunctionPointer</span>&lt;Ret (Obj::*) (Args...)&gt;</span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">typedef</span> Obj Object;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>And seeing what we have passed to <code>KisSignalAutoConnection</code> (in the <a href=\"https://invent.kde.org/kde/krita/merge_requests/41/diffs?commit_id=39262a9385fb933ab428f4a72939a692994e0f21#dbe442eaf45dc765d904fe6d9922b309d19f1d5a\">test code</a>):</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KisSignalAutoConnectionsStore conn;</span><br><span class=\"line\">conn.addConnection(test1.data(), &amp;TestClass::sigTest1, test2.data(), &amp;TestClass::slotTest1);</span><br></pre></td></tr></table></figure>\n<p>We can see that <code>Func1</code> is a member function of <code>TestClass</code>, so <code>QtPrivate::FunctionPointer&lt;Func1&gt;::Object</code> \nis just <code>TestClass</code>. But the constructor of <code>KisSignalAutoConnection</code> receives a <code>const QObject *</code>. \nThe problem here is that <code>connect()</code> is expecting a <code>const TestClass *</code>, but we give them a <code>const QObject *</code>. \nA base class pointer cannot be implicitly converted to a derived class pointer, so we have that error. </p>\n<p>The resolution seems pretty simple, as we only need to include the types of <code>sender</code> and <code>receiver</code> \ninto the template, and pass everything as-is to <code>QObject::connect()</code>: </p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Sender</span>, <span class=\"title\">class</span> <span class=\"title\">Signal</span>, <span class=\"title\">class</span> <span class=\"title\">Receiver</span>, <span class=\"title\">class</span> <span class=\"title\">Method</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"title\">inline</span> <span class=\"title\">KisSignalAutoConnection</span>(<span class=\"title\">Sender</span> <span class=\"title\">sender</span>, <span class=\"title\">Signal</span> <span class=\"title\">signal</span>, <span class=\"title\">Receiver</span> <span class=\"title\">receiver</span>, <span class=\"title\">Method</span> <span class=\"title\">method</span>,</span></span><br><span class=\"line\"><span class=\"class\">                               <span class=\"title\">Qt</span>:</span>:ConnectionType type = Qt::AutoConnection);</span><br></pre></td></tr></table></figure>\n<p>Sounds viable. But how can we store the four parameters? It might be intuitive to make another base class, \nsay, <code>KisSignalAutoConnectionBase()</code>, and make <code>KisSignalAutoConnection</code> a template class, so we can \nstore <code>sender</code>, <code>receiver</code>, etc.</p>\n<p>But wait, isn’t this just too complex? First of all, we do not have any overridden functions \nexcept for the destructor. What is more, we do not seem to have any valuable things in that base \nclass – it would be an empty class. The use of inheritance here is ugly and useless. </p>\n<p>And, we do not need to store the four parameters at all. <code>QObject::connect()</code> returns a \n<code>QMetaObject::Connection</code>, which can be used later to <code>disconnect()</code> it. So instead of \nthe parameters passed to <code>connect()</code>, we just store the <code>Connection</code> object. And that is not \npart of the template:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"keyword\">template</span>&lt;<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Sender</span>, <span class=\"title\">class</span> <span class=\"title\">Signal</span>, <span class=\"title\">class</span> <span class=\"title\">Receiver</span>, <span class=\"title\">class</span> <span class=\"title\">Method</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">inline</span> <span class=\"title\">KisSignalAutoConnection</span>(<span class=\"title\">Sender</span> <span class=\"title\">sender</span>, <span class=\"title\">Signal</span> <span class=\"title\">signal</span>, <span class=\"title\">Receiver</span> <span class=\"title\">receiver</span>, <span class=\"title\">Method</span> <span class=\"title\">method</span>,</span></span><br><span class=\"line\"><span class=\"class\">                                   <span class=\"title\">Qt</span>:</span>:ConnectionType type = Qt::AutoConnection)</span><br><span class=\"line\">        : m_connection(QObject::connect(sender, signal, receiver, method, type))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">inline</span> ~KisSignalAutoConnection()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        QObject::disconnect(m_connection);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    QMetaObject::Connection m_connection;</span><br></pre></td></tr></table></figure>\n<p>And with the <a href=\"https://invent.kde.org/kde/krita/merge_requests/41/diffs?commit_id=39262a9385fb933ab428f4a72939a692994e0f21#dbe442eaf45dc765d904fe6d9922b309d19f1d5a\">test code</a> mentioned above, \nwe do make sure that the new implementation works well with both syntaxes. </p>\n<p>So, great, krita developers, we can use the new syntax for auto connections as well. </p>\n<p>PS: There will soon be another post on my work of the snapshot docker – it’s almost finished!</p>\n",
            "tags": [
                "kde",
                "krita",
                "c++",
                "tech"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/05/30/Assistants-copy-share-assignment/",
            "url": "http://tusooa.github.io/2019/05/30/Assistants-copy-share-assignment/",
            "title": "Assistants -- copy, share, assignment",
            "date_published": "2019-05-30T18:20:53.000Z",
            "content_html": "<p>Over the last week I have been investigating into <a href=\"https://bugs.kde.org/show_bug.cgi?id=361012\">Bug 361012</a>, \non the undo history of the modification of guides. But from the very beginning I mixed up the two terms \n“guides” and “assistants,” so I decided to <a href=\"https://invent.kde.org/kde/krita/merge_requests/32\">work on both</a>. \nThe work with guides is a lot simpler and will not be covered here, though. </p>\n<p>As I write this post, the <a href=\"https://invent.kde.org/kde/krita/tree/master\">master branch of Krita</a> \ndoes not create any undo commands for the document. I first <a href=\"https://invent.kde.org/kde/krita/merge_requests/32/diffs?commit_id=12bc1d0730f04321c5ec304ce09f6670ef14c576\">added undo commands</a> for adding and removing \nassistants, which seems the easiest. The editing of them is a bit more difficult, as the dragging \noperations involve the movement of many “handles,” the movable round buttons that define the position \nof one or more assistants. The source code on master for implementing such actions is quite complicated \nand involves a great number of cases. It would be another great endeavour to put all these bunches of \ncode into a <code>KUndo2Command</code>. But, another thing I have experimented with and I will be working on \nwill immediately clear the clouds.</p>\n<p>So I just thought of the copy-on-write mechanism, and yes, why not? Though COW itself is not \nactually implemented for the guides, it does seem inspiring. I mean, we can just save a copy \nof all assistants and, when needed, restore that. </p>\n<p>The main problem here is the handles. They are represented as shared pointers in individual \nassistants and may be shared between different ones (e.g. two perspectives share two corner \nhandles and one side handles). When we take a clone of the list of assistants it will be \nnecessary to keep this kind of relationship. My solution is to use a <code>QMap</code> of pointers, \nwhich seems to coincide with the logic of exporting to xml, but I had yet to read that part\nof the code when writing mine so I did not know about that. The logic is to check, for \nevery handle, whether there is a mapping relationship in the map. If there is, we reuse that \nhandle, and if not, we create a new one with the same position and record that relationship \nin our <code>QMap</code>.</p>\n<p>But some display properties are not to be recorded into the undo history. Such properties \ninclude the changing of color, visibility, etc. To resolve this problem, I put these data into \na shared pointer and, when we are cloning an assistant for undo/redo, we will reuse that pointer.\nWhen we replace the assistant list with the one recorded, all the display properties will remain \nsince the data are shared. </p>\n<p>And for the next several weeks I will move onto the <a href=\"https://phabricator.kde.org/T10991\">Snapshot Docker</a>.</p>\n",
            "tags": [
                "kde",
                "krita",
                "c++",
                "code"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/05/18/Polymorphism-and-Implicit-Sharing/",
            "url": "http://tusooa.github.io/2019/05/18/Polymorphism-and-Implicit-Sharing/",
            "title": "Polymorphism and Implicit Sharing",
            "date_published": "2019-05-18T18:18:41.000Z",
            "content_html": "<p>Recently I have been researching into possibilities to make members of <code>KoShape</code> copy-on-write. \nAt first glance, it seems enough to declare d-pointers as some subclass of <code>QSharedDataPointer</code> \n(see Qt’s <a href=\"https://doc.qt.io/qt-5/implicit-sharing.html\">implicit sharing</a>) and then replace \npointers with instances. However, there remain a number of problems to be solved, one of them \nbeing polymorphism.</p>\n<h2 id=\"polymorphism-and-value-semantics\"><a href=\"#polymorphism-and-value-semantics\" class=\"headerlink\" title=\"polymorphism and value semantics\"></a>polymorphism and value semantics</h2><p>In the <a href=\"https://invent.kde.org/kde/krita/blob/aeb8a1097ad58eaff91aa34c40b18e82428b0a3a/libs/flake/KoShape_p.h#L65\">definition</a> \nof <code>KoShapePrivate</code> class, the member <code>fill</code> is stored as a <code>QSharedPointer</code>:</p>\n<pre><code>QSharedPointer&lt;KoShapeBackground&gt; fill;\n</code></pre><p>There are a number of subclasses of <code>KoShapeBackground</code>, including <code>KoColorBackground</code>, \n<code>KoGradientBackground</code>, to name just a few. We cannot store an instance of <code>KoShapeBackground</code> \ndirectly since we want polymorphism. But, well, making <code>KoShapeBackground</code> copy-on-write seems to have \nnothing to do with whether we store it as a pointer or instance. So let’s just put it here – \nI will come back to this question at the end of this post.</p>\n<h2 id=\"d-pointers-and-QSharedData\"><a href=\"#d-pointers-and-QSharedData\" class=\"headerlink\" title=\"d-pointers and QSharedData\"></a>d-pointers and <code>QSharedData</code></h2><p>The <code>KoShapeBackground</code> heirarchy (similar to the <code>KoShape</code> one) uses derived d-pointers\nfor storing private data. To make things easier, I will here use a small example to \nelaborate on its use. </p>\n<h3 id=\"derived-d-pointer\"><a href=\"#derived-d-pointer\" class=\"headerlink\" title=\"derived d-pointer\"></a>derived d-pointer</h3><figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractPrivate</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    AbstractPrivate() : var(<span class=\"number\">0</span>) &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~AbstractPrivate() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> var;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Abstract</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"comment\">// it is not yet copy-constructable; we will come back to this later</span></span><br><span class=\"line\">    <span class=\"comment\">// Abstract(const Abstract &amp;other) = default;</span></span><br><span class=\"line\">    ~Abstract() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">Abstract</span><span class=\"params\">(AbstractPrivate &amp;dd)</span> : <span class=\"title\">d_ptr</span><span class=\"params\">(&amp;dd)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">modifyVar</span><span class=\"params\">()</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    QScopedPointer&lt;AbstractPrivate&gt; d_ptr;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    Q_DECLARE_PRIVATE(Abstract)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DerivedPrivate</span> :</span> <span class=\"keyword\">public</span> AbstractPrivate</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    DerivedPrivate() : AbstractPrivate(), bar(<span class=\"number\">0</span>) &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~DerivedPrivate() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> bar;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Derived</span> :</span> <span class=\"keyword\">public</span> Abstract</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    Derived() : Abstract(*(<span class=\"keyword\">new</span> DerivedPrivate)) &#123;&#125;</span><br><span class=\"line\">    <span class=\"comment\">// it is not yet copy-constructable</span></span><br><span class=\"line\">    <span class=\"comment\">// Derived(const Derived &amp;other) = default;</span></span><br><span class=\"line\">    ~Derived() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">Derived</span><span class=\"params\">(AbstractPrivate &amp;dd)</span> : <span class=\"title\">Abstract</span><span class=\"params\">(dd)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> <span class=\"keyword\">override</span> </span>&#123; Q_D(<span class=\"keyword\">const</span> Derived); <span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;foo &quot;</span> &lt;&lt; d-&gt;var &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; d-&gt;bar &lt;&lt; <span class=\"built_in\">endl</span>; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">modifyVar</span><span class=\"params\">()</span> <span class=\"keyword\">override</span> </span>&#123; Q_D(Derived); d-&gt;var++; d-&gt;bar++; &#125;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    Q_DECLARE_PRIVATE(Derived)</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>The main goal of making <code>DerivedPrivate</code> a subclass of <code>AbstractPrivate</code> is to avoid multiple \nd-pointers in the structure. Note that there are constructors taking a reference to the \nprivate data object. These are to make it possible for a <code>Derived</code> object to use the same\nd-pointer as its <code>Abstract</code> parent. The <code>Q_D()</code> macro is used to convert the <code>d_ptr</code>, which is a \npointer to <code>AbstractPrivate</code> to another pointer, named <code>d</code>, of some of its descendent type; \nhere, it is a <code>DerivedPrivate</code>. It is used together with the <code>Q_DECLARE_PRIVATE()</code> macro \nin the class definition \nand has a rather complicated implementation in the Qt headers. But for simplicity, it does \nnot hurt for now to understand it as the following:</p>\n<pre><code>#define Q_D(Class) Class##Private *const d = reinterpret_cast&lt;Class##Private *&gt;(d_ptr.data())\n</code></pre><p>where <code>Class##Private</code> means simply to append string <code>Private</code> to (the macro argument) <code>Class</code>. </p>\n<p>Now let’s test it by creating a pointer to <code>Abstract</code> and give it a <code>Derived</code> object:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"function\">QScopedPointer&lt;Abstract&gt; <span class=\"title\">ins</span><span class=\"params\">(<span class=\"keyword\">new</span> Derived())</span></span>;</span><br><span class=\"line\">    ins-&gt;foo();</span><br><span class=\"line\">    ins-&gt;modifyVar();</span><br><span class=\"line\">    ins-&gt;foo();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Output:</p>\n<pre><code>foo 0 0\nfoo 1 1\n</code></pre><p>Looks pretty viable – everything’s working well! – What if we use Qt’s implicit sharing? Just \nmake <code>AbstractPrivate</code> a subclass of <code>QSharedData</code> and replace <code>QScopedPointer</code> with <code>QSharedDataPointer</code>.</p>\n<h3 id=\"making-d-pointer-QSharedDataPointer\"><a href=\"#making-d-pointer-QSharedDataPointer\" class=\"headerlink\" title=\"making d-pointer QSharedDataPointer\"></a>making d-pointer <code>QSharedDataPointer</code></h3><p>In the last section, we commented out the copy constructors since <code>QScopedPointer</code> is not copy-constructable,\nbut here <code>QSharedDataPointer</code> is copy-constructable, so we add them back:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractPrivate</span> :</span> <span class=\"keyword\">public</span> QSharedData</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    AbstractPrivate() : var(<span class=\"number\">0</span>) &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~AbstractPrivate() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> var;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Abstract</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    Abstract(<span class=\"keyword\">const</span> Abstract &amp;other) = <span class=\"keyword\">default</span>;</span><br><span class=\"line\">    ~Abstract() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">Abstract</span><span class=\"params\">(AbstractPrivate &amp;dd)</span> : <span class=\"title\">d_ptr</span><span class=\"params\">(&amp;dd)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">modifyVar</span><span class=\"params\">()</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    QSharedDataPointer&lt;AbstractPrivate&gt; d_ptr;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    Q_DECLARE_PRIVATE(Abstract)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DerivedPrivate</span> :</span> <span class=\"keyword\">public</span> AbstractPrivate</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    DerivedPrivate() : AbstractPrivate(), bar(<span class=\"number\">0</span>) &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~DerivedPrivate() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> bar;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Derived</span> :</span> <span class=\"keyword\">public</span> Abstract</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    Derived() : Abstract(*(<span class=\"keyword\">new</span> DerivedPrivate)) &#123;&#125;</span><br><span class=\"line\">    Derived(<span class=\"keyword\">const</span> Derived &amp;other) = <span class=\"keyword\">default</span>;</span><br><span class=\"line\">    ~Derived() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">Derived</span><span class=\"params\">(AbstractPrivate &amp;dd)</span> : <span class=\"title\">Abstract</span><span class=\"params\">(dd)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> <span class=\"keyword\">override</span> </span>&#123; Q_D(<span class=\"keyword\">const</span> Derived); <span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;foo &quot;</span> &lt;&lt; d-&gt;var &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; d-&gt;bar &lt;&lt; <span class=\"built_in\">endl</span>; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">modifyVar</span><span class=\"params\">()</span> <span class=\"keyword\">override</span> </span>&#123; Q_D(Derived); d-&gt;var++; d-&gt;bar++; &#125;</span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">    Q_DECLARE_PRIVATE(Derived)</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>And testing the copy-on-write mechanism:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"function\">QScopedPointer&lt;Derived&gt; <span class=\"title\">ins</span><span class=\"params\">(<span class=\"keyword\">new</span> Derived())</span></span>;</span><br><span class=\"line\">    <span class=\"function\">QScopedPointer&lt;Derived&gt; <span class=\"title\">ins2</span><span class=\"params\">(<span class=\"keyword\">new</span> Derived(*ins))</span></span>;</span><br><span class=\"line\">    ins-&gt;foo();</span><br><span class=\"line\">    ins-&gt;modifyVar();</span><br><span class=\"line\">    ins-&gt;foo();</span><br><span class=\"line\">    ins2-&gt;foo();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>But, eh, it’s a compile-time error.</p>\n<pre><code>error: reinterpret_cast from type &apos;const AbstractPrivate*&apos; to type &apos;AbstractPrivate*&apos; casts away qualifiers\n Q_DECLARE_PRIVATE(Abstract)\n</code></pre><h3 id=\"Q-D-revisited\"><a href=\"#Q-D-revisited\" class=\"headerlink\" title=\"Q_D, revisited\"></a><code>Q_D</code>, revisited</h3><p>So, where does the <code>const</code> removal come from? In <code>qglobal.h</code>, the code related to <code>Q_D</code> is as follows:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span> &lt;<span class=\"keyword\">typename</span> T&gt; <span class=\"function\"><span class=\"keyword\">inline</span> T *<span class=\"title\">qGetPtrHelper</span><span class=\"params\">(T *ptr)</span> </span>&#123; <span class=\"keyword\">return</span> ptr; &#125;</span><br><span class=\"line\">template &lt;typename Ptr&gt; inline auto qGetPtrHelper(const Ptr &amp;ptr) -&gt; decltype(ptr.operator-&gt;()) &#123; return ptr.operator-&gt;(); &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// The body must be a statement:</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> Q_CAST_IGNORE_ALIGN(body) QT_WARNING_PUSH QT_WARNING_DISABLE_GCC(<span class=\"meta-string\">&quot;-Wcast-align&quot;</span>) body QT_WARNING_POP</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> Q_DECLARE_PRIVATE(Class) \\</span></span><br><span class=\"line\">    inline Class##Private* d_func() \\</span><br><span class=\"line\">    &#123; Q_CAST_IGNORE_ALIGN(<span class=\"keyword\">return</span> <span class=\"keyword\">reinterpret_cast</span>&lt;Class##Private *&gt;(qGetPtrHelper(d_ptr));) &#125; \\</span><br><span class=\"line\">    inline const Class##Private* d_func() const \\</span><br><span class=\"line\">    &#123; Q_CAST_IGNORE_ALIGN(<span class=\"keyword\">return</span> <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">const</span> Class##Private *&gt;(qGetPtrHelper(d_ptr));) &#125; \\</span><br><span class=\"line\">    <span class=\"keyword\">friend</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Class</span>##<span class=\"title\">Private</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> Q_D(Class) Class##Private * const d = d_func()</span></span><br></pre></td></tr></table></figure>\n<p>It turns out that <code>Q_D</code> will call <code>d_func()</code> which then calls an overload of <code>qGetPtrHelper()</code> \nthat takes <code>const Ptr &amp;ptr</code>. What does <code>ptr.operator-&gt;()</code> return? What is the difference between \n<code>QScopedPointer</code> and <code>QSharedDataPointer</code> here?</p>\n<p><a href=\"https://doc.qt.io/qt-5/qscopedpointer.html#operator--gt\"><code>QScopedPointer</code></a>‘s <code>operator-&gt;()</code> is a \n<code>const</code> method that returns a non-<code>const</code> pointer to <code>T</code>; however, \n<a href=\"https://doc.qt.io/qt-5/qshareddatapointer.html#operator--gt\"><code>QSharedDataPointer</code></a> has two \n<code>operator-&gt;()</code>s, one being <code>const T* operator-&gt;() const</code>, the other <code>T* operator-&gt;()</code>, and they\nhave quite different behaviours – the non-<code>const</code> variant calls <code>detach()</code> (where copy-on-write \nis implemented), but the other one does not.</p>\n<p><code>qGetPtrHelper()</code> here can only take <code>d_ptr</code> as a <code>const QSharedDataPointer</code>, not a non-<code>const</code> \none; so, no matter which <code>d_func()</code> we are calling, we can only get a <code>const AbstractPrivate *</code>. \nThat is just the problem here. </p>\n<p>To resolve this problem, let’s replace the <code>Q_D</code> macros with the ones we define ourselves:</p>\n<pre><code>#define CONST_SHARED_D(Class) const Class##Private *const d = reinterpret_cast&lt;const Class##Private *&gt;(d_ptr.constData())\n#define SHARED_D(Class) Class##Private *const d = reinterpret_cast&lt;Class##Private *&gt;(d_ptr.data())\n</code></pre><p>We will then use <code>SHARED_D(Class)</code> in place of <code>Q_D(Class)</code> and <code>CONST_SHARED_D(Class)</code> for \n<code>Q_D(const Class)</code>. Since the <code>const</code> and non-<code>const</code> variant really behaves differently, \nit should help to differentiate these two uses. Also, delete <code>Q_DECLARE_PRIVATE</code> since we \ndo not need them any more:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractPrivate</span> :</span> <span class=\"keyword\">public</span> QSharedData</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    AbstractPrivate() : var(<span class=\"number\">0</span>) &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~AbstractPrivate() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> var;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Abstract</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    Abstract(<span class=\"keyword\">const</span> Abstract &amp;other) = <span class=\"keyword\">default</span>;</span><br><span class=\"line\">    ~Abstract() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">Abstract</span><span class=\"params\">(AbstractPrivate &amp;dd)</span> : <span class=\"title\">d_ptr</span><span class=\"params\">(&amp;dd)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">modifyVar</span><span class=\"params\">()</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    QSharedDataPointer&lt;AbstractPrivate&gt; d_ptr;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DerivedPrivate</span> :</span> <span class=\"keyword\">public</span> AbstractPrivate</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    DerivedPrivate() : AbstractPrivate(), bar(<span class=\"number\">0</span>) &#123;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">virtual</span> ~DerivedPrivate() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> bar;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Derived</span> :</span> <span class=\"keyword\">public</span> Abstract</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    Derived() : Abstract(*(<span class=\"keyword\">new</span> DerivedPrivate)) &#123;&#125;</span><br><span class=\"line\">    Derived(<span class=\"keyword\">const</span> Derived &amp;other) = <span class=\"keyword\">default</span>;</span><br><span class=\"line\">    ~Derived() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\"><span class=\"keyword\">protected</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">Derived</span><span class=\"params\">(AbstractPrivate &amp;dd)</span> : <span class=\"title\">Abstract</span><span class=\"params\">(dd)</span> </span>&#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> <span class=\"keyword\">override</span> </span>&#123; CONST_SHARED_D(Derived); <span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;foo &quot;</span> &lt;&lt; d-&gt;var &lt;&lt; <span class=\"string\">&quot; &quot;</span> &lt;&lt; d-&gt;bar &lt;&lt; <span class=\"built_in\">endl</span>; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">modifyVar</span><span class=\"params\">()</span> <span class=\"keyword\">override</span> </span>&#123; SHARED_D(Derived); d-&gt;var++; d-&gt;bar++; &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>With the same <code>main()</code> code, what’s the result?</p>\n<pre><code>foo 0 0\nfoo 1 16606417\nfoo 0 0\n</code></pre><p>… big whoops, what is that random thing there? Well, if we use <code>dynamic_cast</code> in place of \n<code>reinterpret_cast</code>, the program simply crashes after <code>ins-&gt;modifyVar();</code>, indicating that \n<code>ins</code>‘s <code>d_ptr.data()</code> is not at all a <code>DerivedPrivate</code>.</p>\n<h3 id=\"virtual-clones\"><a href=\"#virtual-clones\" class=\"headerlink\" title=\"virtual clones\"></a>virtual clones</h3><p>The <code>detach()</code> method of <code>QSharedDataPointer</code> will by default create an instance of <code>AbstractPrivate</code> \nregardless of what the instance really is. Fortunately, it is possible to change that behaviour \nthrough <a href=\"https://doc.qt.io/qt-5/qshareddatapointer.html#clone\">specifying the <code>clone()</code> method</a>.</p>\n<p>First, we need to make a virtual function in <code>AbstractPrivate</code> class:</p>\n<pre><code>virtual AbstractPrivate *clone() const = 0;\n</code></pre><p>(make it pure virtual just to force all subclasses to re-implement it; if your base class is \nnot abstract you probably want to implement the <code>clone()</code> method) and then override it \nin <code>DerivedPrivate</code>:</p>\n<pre><code>virtual DerivedPrivate *clone() const &#123; return new DerivedPrivate(*this); &#125;\n</code></pre><p>Then, specify the template method for <code>QSharedDataPointer::clone()</code>. As we will re-use it multiple\ntimes (for different base classes), it is better to define a macro:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> DATA_CLONE_VIRTUAL(Class) template<span class=\"meta-string\">&lt;&gt;                      \\</span></span></span><br><span class=\"line\">    Class##Private *QSharedDataPointer&lt;Class##Private&gt;::clone()   \\</span><br><span class=\"line\">    &#123;                                                             \\</span><br><span class=\"line\">        <span class=\"keyword\">return</span> d-&gt;clone();                                        \\</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\">// after the definition of Abstract</span></span><br><span class=\"line\">DATA_CLONE_VIRTUAL(Abstract)</span><br></pre></td></tr></table></figure>\n<p>It is not necessary to write <code>DATA_CLONE_VIRTUAL(Derived)</code> as we are never storing a \n<code>QSharedDataPointer&lt;DerivedPrivate&gt;</code> throughout the heirarchy.</p>\n<p>Then test the code again:</p>\n<pre><code>foo 0 0\nfoo 1 1\nfoo 0 0\n</code></pre><p>– Just as expected! It continues to work if we replace <code>Derived</code> with <code>Abstract</code> in <code>QScopedPointer</code>:</p>\n<pre><code>QScopedPointer&lt;Abstract&gt; ins(new Derived());\nQScopedPointer&lt;Abstract&gt; ins2(new Derived(* dynamic_cast&lt;const Derived *&gt;(ins.data())));\n</code></pre><p>Well, another problem comes, that the constructor for <code>ins2</code> seems too ugly, and messy. We could, like \nthe private classes, implement a virtual function <code>clone()</code> for these kinds of things, but it is \nstill not gentle enough, and we cannot use a default copy constructor for any class that contains \nsuch <code>QScopedPointer</code>s.</p>\n<p>What about <code>QSharedPointer</code> that is copy-constructable? Well, then these copies actually point to \nthe same data structures and no copy-on-write is performed at all. This still not wanted. </p>\n<h2 id=\"the-Descendents-of-…\"><a href=\"#the-Descendents-of-…\" class=\"headerlink\" title=\"the Descendents of …\"></a>the <code>Descendent</code>s of …</h2><p>Inspired by <a href=\"https://www.youtube.com/watch?v=QGcVXgEVMJg\">Sean Parent’s video</a>, \nI finally come up with the following implementation:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">template</span>&lt;<span class=\"keyword\">typename</span> T&gt;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Descendent</span></span></span><br><span class=\"line\"><span class=\"class\">&#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">concept</span></span></span><br><span class=\"line\"><span class=\"class\">    &#123;</span></span><br><span class=\"line\">        <span class=\"keyword\">virtual</span> ~<span class=\"keyword\">concept</span>() = <span class=\"keyword\">default</span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"keyword\">const</span> T *<span class=\"title\">ptr</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">virtual</span> T *<span class=\"title\">ptr</span><span class=\"params\">()</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">virtual</span> <span class=\"built_in\">unique_ptr</span>&lt;<span class=\"keyword\">concept</span>&gt; <span class=\"title\">clone</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>= <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">template</span>&lt;<span class=\"keyword\">typename</span> U&gt;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">model</span> :</span> <span class=\"keyword\">public</span> <span class=\"keyword\">concept</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        model(U x) : instance(move(x)) &#123;&#125;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">const</span> T *<span class=\"title\">ptr</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>&#123; <span class=\"keyword\">return</span> &amp;instance; &#125;</span><br><span class=\"line\">        <span class=\"function\">T *<span class=\"title\">ptr</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> &amp;instance; &#125;</span><br><span class=\"line\">        <span class=\"comment\">// or unique_ptr&lt;model&lt;U&gt; &gt;(new model&lt;U&gt;(U(instance))) if you do not have C++14</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"built_in\">unique_ptr</span>&lt;<span class=\"keyword\">concept</span>&gt; <span class=\"title\">clone</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>&#123; <span class=\"keyword\">return</span> make_unique&lt;model&lt;U&gt; &gt;(U(instance)); &#125;</span><br><span class=\"line\">        U instance;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">unique_ptr</span>&lt;<span class=\"keyword\">concept</span>&gt; m_d;</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">    <span class=\"keyword\">template</span>&lt;<span class=\"keyword\">typename</span> U&gt;</span><br><span class=\"line\">    Descendent(U x) : m_d(make_unique&lt;model&lt;U&gt; &gt;(move(x))) &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Descendent(<span class=\"keyword\">const</span> Descendent &amp; that) : m_d(move(that.m_d-&gt;clone())) &#123;&#125;</span><br><span class=\"line\">    Descendent(Descendent &amp;&amp; that) : m_d(move(that.m_d)) &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Descendent &amp; <span class=\"keyword\">operator</span>=(<span class=\"keyword\">const</span> Descendent &amp;that) &#123; Descendent t(that); *<span class=\"keyword\">this</span> = move(t); <span class=\"keyword\">return</span> *<span class=\"keyword\">this</span>; &#125;</span><br><span class=\"line\">    Descendent &amp; <span class=\"keyword\">operator</span>=(Descendent &amp;&amp; that) &#123; m_d = move(that.m_d); <span class=\"keyword\">return</span> *<span class=\"keyword\">this</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">const</span> T *<span class=\"title\">data</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>&#123; <span class=\"keyword\">return</span> m_d-&gt;ptr(); &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">const</span> T *<span class=\"title\">constData</span><span class=\"params\">()</span> <span class=\"keyword\">const</span> </span>&#123; <span class=\"keyword\">return</span> m_d-&gt;ptr(); &#125;</span><br><span class=\"line\">    <span class=\"function\">T *<span class=\"title\">data</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> m_d-&gt;ptr(); &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> T *<span class=\"keyword\">operator</span>-&gt;() <span class=\"keyword\">const</span> &#123; <span class=\"keyword\">return</span> m_d-&gt;ptr(); &#125;</span><br><span class=\"line\">    T *<span class=\"keyword\">operator</span>-&gt;() &#123; <span class=\"keyword\">return</span> m_d-&gt;ptr(); &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>This class allows you to use <code>Descendent&lt;T&gt;</code> (read as “descendent of <code>T</code>“) to represent any instance \nof any subclass of <code>T</code>. It is copy-constructable, move-constructable, copy-assignable, and move-assignable. </p>\n<p>Test code:</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    Descendent&lt;Abstract&gt; ins = Derived();</span><br><span class=\"line\">    Descendent&lt;Abstract&gt; ins2 = ins;</span><br><span class=\"line\">    ins-&gt;foo();</span><br><span class=\"line\">    ins-&gt;modifyVar();</span><br><span class=\"line\">    ins-&gt;foo();</span><br><span class=\"line\">    ins2-&gt;foo();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>It gives just the same results as before, but much neater and nicer – How does it work?</p>\n<p>First we define a class <code>concept</code>. We put here what we want our instance to satisfy. We would like to \naccess it as <code>const</code> and non-<code>const</code>, and to clone it as-is. Then we define a template class <code>model&lt;U&gt;</code> \nwhere <code>U</code> is a subclass of <code>T</code>, and implement these functionalities.</p>\n<p>Next, we store a <code>unique_ptr&lt;concept&gt;</code>. The reason for not using <code>QScopedPointer</code> is <code>QScopedPointer</code> is not \nmovable, but movability is a feature we actually will want (in sink arguments and return values).</p>\n<p>Finally it’s just the constructor, moving and copying operations, and ways to access the wrapped object.</p>\n<p>When <code>Descendent&lt;Abstract&gt; ins2 = ins;</code> is called, we will go through the copy constructor of <code>Descendent</code>:</p>\n<pre><code>Descendent(const Descendent &amp; that) : m_d(move(that.m_d-&gt;clone())) &#123;&#125;\n</code></pre><p>which will then call <code>ins.m_d-&gt;clone()</code>. But remember that <code>ins.m_d</code> actually contains a pointer to \n<code>model&lt;Derived&gt;</code>, whose <code>clone()</code> is <code>return make_unique&lt;model&lt;Derived&gt; &gt;(Derived(instance));</code>. This expression \nwill call the copy constructor of <code>Derived</code>, then make a <code>unique_ptr&lt;model&lt;Derived&gt; &gt;</code>, which calls the \nconstructor of <code>model&lt;Derived&gt;</code>:</p>\n<pre><code>model(Derived x) : instance(move(x)) &#123;&#125;\n</code></pre><p>which move-constructs <code>instance</code>. Finally the <code>unique_ptr&lt;model&lt;Derived&gt; &gt;</code> is implicitly converted to \n<code>unique_ptr&lt;concept&gt;</code>, as per the <a href=\"https://en.cppreference.com/w/cpp/memory/unique_ptr\">conversion rule</a>. \n“If <code>T</code> is a derived class of some base <code>B</code>, then <code>std::unique_ptr&lt;T&gt;</code> is implicitly convertible to \n<code>std::unique_ptr&lt;B&gt;</code>.”</p>\n<p>And from now on, happy hacking — (.&gt;w&lt;.)</p>\n",
            "tags": [
                "kde",
                "krita",
                "c++",
                "tech"
            ]
        },
        {
            "id": "http://tusooa.github.io/2019/05/13/GSoC-2019/",
            "url": "http://tusooa.github.io/2019/05/13/GSoC-2019/",
            "title": "GSoC 2019",
            "date_published": "2019-05-13T15:16:48.000Z",
            "content_html": "<p>This summer will be a little bit interesting as I joined the\n<a href=\"https://summerofcode.withgoogle.com/\">Google Summer of Code</a> (GSoC).\nThe software I will be working on is <a href=\"https://krita.org/\">Krita</a>.\nKrita is a painting software I have been using for more than one year.\nSince the (pre)release of Krita 4.0, I use it to <a href=\"https://www.deviantart.com/thistusooa\">paint all my works</a>.</p>\n<p>Before using Krita, I used to use PaintToolSAI, and there are quite a lot of concepts\nand functionalities in it that I find really useful; after getting involved in the\nKrita community I am pretty lucky to be able to introduce these little shiny stars\nto our community, and even <a href=\"https://github.com/tusooa/krita-docker-color-slider\">implement some of them</a>.</p>\n<p><a href=\"https://phabricator.kde.org/T10901\">My project for GSoC</a> is on\n<a href=\"https://invent.kde.org/kde/krita/tree/master/libs/command\">the undo/redo system in Krita</a>. \nThe system currently works using an undo stack to storage individual changes to the document,\nand invoking these commands to perform undos and redos. This system is complex and not easy\nto maintain. As <a href=\"https://invent.kde.org/dkazakov\">Dmitry</a> suggests, a better solution would\nbe <a href=\"https://www.youtube.com/watch?v=QGcVXgEVMJg\">storing the states of the document as shallow copies</a>, \nsince it simplifies the system and make history brushes possible. It would be a rather huge\nand fundamental change in the code, and he recommends me to experiment with vector layers first.</p>\n<p>Another part of the project, which is not a research, is the snapshot docker that would allow\nusers to temporarily save some states of the document and return to them quickly at a later time.\nThis is an enhancement on the GUI level, as the tile data in paint layers are shallow copied, making\nit possible to make a clone of the document relatively fast. </p>\n<p>I will make more posts on KDE and Krita in the near future. Let’s keep in touch! (.w.)</p>\n",
            "tags": [
                "kde",
                "krita"
            ]
        },
        {
            "id": "http://tusooa.github.io/2018/04/29/short-code/",
            "url": "http://tusooa.github.io/2018/04/29/short-code/",
            "title": "短代码(一个马后炮)",
            "date_published": "2018-04-29T10:58:57.000Z",
            "content_html": "<p>没赶上报名截止日期，一直 <code>not invited</code>。就很难过。</p>\n<p>E 的题目描述是这样的。</p>\n<h1 id=\"Description\"><a href=\"#Description\" class=\"headerlink\" title=\"Description\"></a>Description</h1><p>tz学姐做题很忙，有一些简单的问题需要你帮忙解决：给定三个序列A,B,C和一个整数X, 现在需要找到三个数Ai，Bj，Ck，满足Ai+Bj+Ck = X.</p>\n<h1 id=\"Input\"><a href=\"#Input\" class=\"headerlink\" title=\"Input\"></a>Input</h1><p>第1行三个整数 L, N, M；</p>\n<p>第2行L个整数代表序列A</p>\n<p>第3行M个整数代表序列B</p>\n<p>第4行N个整数代表序列C</p>\n<p>第5行1个整数S代表有S个X。</p>\n<p>接下来的S行每行一个整数X</p>\n<p>1&lt;=L, N, M&lt;=500, 1&lt;=S&lt;=1000. 所有整数均在32位整数范围内</p>\n<h1 id=\"Output\"><a href=\"#Output\" class=\"headerlink\" title=\"Output\"></a>Output</h1><p>对于S个询问计算X对应的公式是否能被满足。 如能满足，输出 “YES”, 否则输出 “NO”。</p>\n<h1 id=\"Sample-Input\"><a href=\"#Sample-Input\" class=\"headerlink\" title=\"Sample Input\"></a>Sample Input</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">3 3 3</span><br><span class=\"line\">1 2 3</span><br><span class=\"line\">1 2 3</span><br><span class=\"line\">1 2 3</span><br><span class=\"line\">3</span><br><span class=\"line\">1</span><br><span class=\"line\">4</span><br><span class=\"line\">10</span><br></pre></td></tr></table></figure>\n<h1 id=\"Sample-Output\"><a href=\"#Sample-Output\" class=\"headerlink\" title=\"Sample Output\"></a>Sample Output</h1><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NO</span><br><span class=\"line\">YES</span><br><span class=\"line\">NO</span><br></pre></td></tr></table></figure>\n<h1 id=\"喵\"><a href=\"#喵\" class=\"headerlink\" title=\"喵\"></a>喵</h1><p>我当时给出的代码是这样的。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;algorithm&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> <span class=\"built_in\">std</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> l,m,n;</span><br><span class=\"line\">  <span class=\"built_in\">cin</span>&gt;&gt;l&gt;&gt;m&gt;&gt;n;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> a[l],b[m],c[n];</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;p:a)<span class=\"built_in\">cin</span>&gt;&gt;p;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;p:b)<span class=\"built_in\">cin</span>&gt;&gt;p;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;p:c)<span class=\"built_in\">cin</span>&gt;&gt;p;</span><br><span class=\"line\">  sort(c,c+n);</span><br><span class=\"line\">  <span class=\"built_in\">cin</span>&gt;&gt;n;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> p;<span class=\"built_in\">cin</span>&gt;&gt;p;)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> q:a)</span><br><span class=\"line\">      <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> r:b)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(binary_search(c,c+n,p-q-r)) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">&quot;YES\\n&quot;</span>;</span><br><span class=\"line\">          <span class=\"keyword\">goto</span> l;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    <span class=\"built_in\">cout</span>&lt;&lt;<span class=\"string\">&quot;NO\\n&quot;</span>;</span><br><span class=\"line\">  l:<span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//292</span></span><br></pre></td></tr></table></figure>\n<p>由于我不能提交，无法判断它是否超时了。查了一下网上的做法，是把 <code>a</code> 和 <code>b</code> 加起来存到另一个数组里，然后对这个新的数组排序查找。</p>\n<p>仔细分析一下就是：</p>\n<p>我的方法，排序用了 <code>O(n*log n)</code>，查找 <code>O(n**2*log n)</code>。</p>\n<p>另一个做法，排序 <code>O(n**2*log n)</code>，查找 <code>O(n*log n)</code>。</p>\n<p>看上去好像正好抵消了没什么区别。问题在于查找是<strong>多次</strong>查找，我们希望每次查找的时间尽量短。</p>\n<p>所以改过的代码是这样的：</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;iostream&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;algorithm&gt;</span></span></span><br><span class=\"line\"><span class=\"keyword\">using</span> <span class=\"keyword\">namespace</span> <span class=\"built_in\">std</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> l,m,n,r=<span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"built_in\">cin</span>&gt;&gt;l&gt;&gt;m&gt;&gt;n;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> a[l],b[m],c[n],S[l*m]; <span class=\"comment\">// GNU 扩展的变长数组</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;p:a)<span class=\"built_in\">cin</span>&gt;&gt;p;</span><br><span class=\"line\">  <span class=\"comment\">// range-for 输入第二组数据，同时将输入的数据和第一组的每一个数字相累加，结果存到 `S` 里。</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;p:b) &#123;</span><br><span class=\"line\">    <span class=\"built_in\">cin</span>&gt;&gt;p;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;q:a)S[r++]=p+q;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span>&amp;p:c)<span class=\"built_in\">cin</span>&gt;&gt;p;</span><br><span class=\"line\">  sort(S,S+r);</span><br><span class=\"line\">  <span class=\"built_in\">cin</span>&gt;&gt;n; <span class=\"comment\">// 丢弃个数信息，因为不需要</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> p;<span class=\"built_in\">cin</span>&gt;&gt;p;)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> q:c)</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(binary_search(S,S+r,p-q))&#123;</span><br><span class=\"line\">        <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;YES&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> l; <span class=\"comment\">// 直接跳到下次输入，不输出 NO</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">&quot;NO&quot;</span>);</span><br><span class=\"line\">  l:<span class=\"number\">1</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//311</span></span><br></pre></td></tr></table></figure>\n<p>排名表上最短是345。</p>\n<p>但是有什么用呢。我又不能提交(以后一定要提前关注一下)。</p>\n",
            "tags": [
                "无奈",
                "坑",
                "复杂"
            ]
        },
        {
            "id": "http://tusooa.github.io/2018/01/25/dig-a-hole/",
            "url": "http://tusooa.github.io/2018/01/25/dig-a-hole/",
            "title": "开个坑。。。。",
            "date_published": "2018-01-26T02:08:32.000Z",
            "content_html": "<p>嗯大约就是这样0 0。</p>\n",
            "tags": [
                "坑",
                "帜"
            ]
        }
    ]
}