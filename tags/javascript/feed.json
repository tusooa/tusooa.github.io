{
    "version": "https://jsonfeed.org/version/1",
    "title": "何事西风不待人 • All posts by \"javascript\" tag",
    "description": "<span class='ts-langs-group'><span class='ts-lang-en ts-langs ts-langs-show ts-langs-block'>A poet, painter, and programmer.</span><span class='ts-lang-zh-CN ts-langs ts-langs-show ts-langs-block'>写诗画画码代码的。</span></span>",
    "home_page_url": "http://tusooa.github.io",
    "items": [
        {
            "id": "http://tusooa.github.io/2020/10/01/Fix-firefox-address-bar-clickSelectsAll-bug/",
            "url": "http://tusooa.github.io/2020/10/01/Fix-firefox-address-bar-clickSelectsAll-bug/",
            "title": "Fix firefox address bar clickSelectsAll bug (Spoiler: no re-compilation required.)",
            "date_published": "2020-10-02T00:15:56.000Z",
            "content_html": "<p>A couple of months ago, I opened my Firefox as usual, I found out that\nwhen I click on the address bar, it dared to select everything in it\nas if any creepy browser would do! The first thing I did is to check\nthe <code>clickSelectsAll</code> pref – what I always do first after getting a\nnew install of Firefox on Windows is setting this pref to <code>false</code>,\nand setting <code>doubleClickSelectsAll</code> pref to <code>true</code>: that is the default\nbehaviour for Firefox on GNU/Linux… that time at least…</p>\n<p>Much to my disappointment, the pref are setting correctly, but nothing\nworks. I tried to search for this, but without success, maybe since\nthis bug was so new, or I was to silly to apply the right keywords\n(huh, maybe the latter one?). So I created an account on Mozilla’s\nbugtracker just to open <a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=1629135\">a bug</a>. At the same time I switched\nback to the ESR version of Firefox, which rid me (till recently) of\nthis stupid address bar but still granted me security updates. A\nfew days ago, however, Firefox ESR was unfortunately eventually shipped\nwith this bug, calling for a solution.</p>\n<a id=\"more\"></a>\n<h1 id=\"Some-more-background\"><a href=\"#Some-more-background\" class=\"headerlink\" title=\"Some more background\"></a>Some more background</h1><p>Here I will add more background because I need to complain a lot (&gt;w&lt;).\nIf you would like to see the solution directly, <a href=\"#The-solution\">jump there</a>.</p>\n<p>Someone on bugzilla pointed out that the bug had been\n<a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=1621570\">raised by someone else</a>. Following that bug, I saw that\nthe developer was being pretty toxic and just marked it as <code>WONTFIX</code>,\ndespite many people criticized the buggy behaviour and regarded\nthe original behaviour as signature of Firefox. I finally switched\nfrom Ubuntu to Gentoo after the new ESR, as I would like to have more\ncontrol of my software.</p>\n<p>Yesterday I <a href=\"https://matrix.to/#/!NREUQXSZzhWoQFQpTe:matrix.org/$16014845914171808dKKcm:matrix.org?via=matrix.org&amp;via=tusooa.xyz\">talked</a> to <a href=\"https://outsideofinfinity.wordpress.com/\">tiar</a> about the freedom\nof users to make software behave the way they want, without necessarily\nbeing a developer. I complained that many free/libre software does not\nexcel in this aspect, using Firefox >=75 as an example.</p>\n<p>The thing Firefox developers does, by removing the <code>clickSelectsAll</code>\nprefs, is actually somewhat limiting users’ freedom, as customization\nbecomes harder and harder. This kind of freedom has been brought up\nby a KDE person as <a href=\"https://phabricator.kde.org/T11091\">a goal</a> called “freedom out of the box.”\nIn short, it aims to make changing the behaviour of a program\nas easy as just using it, probably unifying the interface where a program\nis used and where a program is customized.</p>\n<p>And that is reasonable: no one should have to spend quite a long time\nreading an extraordinarily large code base just to make a tiny little\nchange that would significantly improve their lives. We will simply not\nhave that much time. I know tweaking system is fun… (should I say\naddictive?) but still, instant result is always a good-to-have.</p>\n<h1 id=\"The-solution\"><a href=\"#The-solution\" class=\"headerlink\" title=\"The solution\"></a>The solution</h1><p>For Firefox, we do have a <a href=\"https://superuser.com/questions/540851/go-back-to-not-selecting-the-whole-url-when-i-click-the-address-bar\">solution</a> without needing to\nrecompile. That is, to change the <code>omni.ja</code> pack in the Firefox\ndistribution. Based on that I managed to restore the old good\nurlbar behaviour.</p>\n<p>For my <code>firefox-bin</code> on Gentoo, the relevant file is at\n<code>/opt/firefox/browser/omni.ja</code>.</p>\n<p>First make a copy of that file:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -v /opt/firefox/browser/omni.ja omni.ja.orig</span><br></pre></td></tr></table></figure>\n<p>Then unzip the file:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir omni &amp;&amp; unzip -d omni /opt/firefox/browser/omni.ja</span><br></pre></td></tr></table></figure>\n<p>It may return 2, but does not matter.</p>\n<p>Then edit the <code>modules/UrlbarInput.jsm</code>:</p>\n<ol>\n<li><p>Change</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">this</span>._preventClickSelectsAll = <span class=\"built_in\">this</span>.focused;</span><br></pre></td></tr></table></figure>\n<p>to</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">this</span>._preventClickSelectsAll = <span class=\"literal\">true</span>;</span><br></pre></td></tr></table></figure>\n<p>to get the <code>clickSelectsAll</code> behaviour.</p>\n</li>\n<li><p>Change</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br></pre></td></tr></table></figure>\n<p>to</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (event.detail == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.select();</span><br><span class=\"line\">  event.preventDefault();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br></pre></td></tr></table></figure>\n<p>to get the <code>doubleClickSelectsAll</code> behaviour.</p>\n<p>Note that this will <em>not</em> put the url into primary selection\nupon double click. This can be useful sometimes, if you just\nwould like to replace the current url with the one currently\nin primary selection.\nIf you would like to put the url into primary selection\nupon double click, which completely restores the original\nbehaviour, change it to</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (event.detail == <span class=\"number\">2</span>) &#123;</span><br><span class=\"line\">  <span class=\"built_in\">this</span>.inputField.select();</span><br><span class=\"line\">  event.preventDefault();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br></pre></td></tr></table></figure>\n<p>instead.</p>\n</li>\n</ol>\n<p>I have also made a patch:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">] diff -Naur omni-old omni</span><br><span class=\"line\">diff -Naur omni-old/modules/UrlbarInput.jsm omni/modules/UrlbarInput.jsm</span><br><span class=\"line\">--- omni-old/modules/UrlbarInput.jsm    2010-01-01 00:00:00.000000000 -0500</span><br><span class=\"line\">+++ omni/modules/UrlbarInput.jsm        2020-10-01 19:50:41.925266392 -0400</span><br><span class=\"line\">@@ -2225,7 +2225,7 @@</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         this.focusedViaMousedown = !this.focused;</span><br><span class=\"line\">-        this._preventClickSelectsAll = this.focused;</span><br><span class=\"line\">+        this._preventClickSelectsAll = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (event.target != this.inputField) &#123;</span><br><span class=\"line\">           this.focus();</span><br><span class=\"line\">@@ -2242,7 +2242,11 @@</span><br><span class=\"line\">           this.selectionStart = this.selectionEnd = 0;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">-        <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br><span class=\"line\">+        // doubleClickSelectsAll</span><br><span class=\"line\">+        <span class=\"keyword\">if</span> (event.detail == 2) &#123;</span><br><span class=\"line\">+          this.select();</span><br><span class=\"line\">+          event.preventDefault();</span><br><span class=\"line\">+        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (event.target.id == SEARCH_BUTTON_ID) &#123;</span><br><span class=\"line\">           this._preventClickSelectsAll = <span class=\"literal\">true</span>;</span><br><span class=\"line\">           this.search(UrlbarTokenizer.RESTRICT.SEARCH);</span><br><span class=\"line\">         &#125; <span class=\"keyword\">else</span> &#123;</span><br></pre></td></tr></table></figure></p>\n<p>There is also the search bar to change. The original Superuser answer\nsuggests this, but as I do not use the search bar, I have not\ntried it out, nor do I know what the original behaviour of it was.\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i <span class=\"string\">&#x27;s/this\\._preventClickSelectsAll = this\\._textbox\\.focused;/this._preventClickSelectsAll = true;/&#x27;</span>  omni/chrome/browser/content/browser/search/searchbar.js</span><br></pre></td></tr></table></figure></p>\n<p>After editing, we need to re-pack the files:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> omni &amp;&amp; zip -0DXqr ../omni.ja * &amp;&amp; <span class=\"built_in\">cd</span> -</span><br></pre></td></tr></table></figure></p>\n<p>And replace the original one:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -v omni.ja /opt/firefox/browser/omni.ja</span><br></pre></td></tr></table></figure></p>\n<p>You may need to change the ownership of the newly-created archive:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown [U]:[G] /opt/firefox/browser/omni.ja</span><br></pre></td></tr></table></figure>\nwhere <code>[U]</code> and <code>[G]</code> refers to the owner and group of the original\nfile (we made a backup at <code>omni.ja.orig</code>).</p>\n<p>To ensure everything takes effect, make a file called <code>.purgecaches</code>\nto make Firefox aware of the changes:\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">touch /opt/firefox/browser/.purgecaches</span><br></pre></td></tr></table></figure></p>\n<p>Okay, from now on, we shall no longer suffer from the <code>clickSelectsAll</code>\nbug.</p>\n<p>Also, you may want to have additional configurations, such as\n<a href=\"https://www.userchrome.org/megabar-styling-firefox-address-bar.html\">disabling the pop-up list upon clicking address bar</a>\nor <a href=\"https://github.com/WesleyBranton/Remove-Firefox-Megabar/blob/master/remove_megabar.css\">gettind rid of the address bar expanding effect</a>\nwhen clicked upon.</p>\n",
            "tags": [
                "firefox",
                "无奈",
                "坑",
                "javascript"
            ]
        }
    ]
}